# APDW Compass 本番反映手順

## 前提条件

- Firebase CLI がインストールされている（`npm install -g firebase-tools`）
- Firebase プロジェクト `compass-31e9e` にログイン済み（`firebase login`）
- ローカル環境に最新のコードがある

---

## 本番環境情報

- **Firebase プロジェクトID**: `compass-31e9e`
- **Web公開URL**: https://compass-31e9e.web.app/
- **API URL**: https://asia-northeast1-compass-31e9e.cloudfunctions.net/api
- **リージョン**: asia-northeast1

---

## 反映手順

### 1. 最新コードの取得

#### GitHub から取得する場合

```bash
git clone https://github.com/sena-sakuramoto/compass.git
cd compass
```

#### Google Cloud Source Repositories から取得する場合

```bash
gcloud source repos clone compass --project=compass-31e9e
cd compass
```

または

```bash
git clone https://source.developers.google.com/p/compass-31e9e/r/compass
cd compass
```

### 2. 依存関係のインストール

#### Functions（バックエンド）

```bash
cd functions
npm install
cd ..
```

#### Web（フロントエンド）

```bash
cd web
npm install
cd ..
```

### 3. ビルドの確認

#### Functions のビルド

```bash
cd functions
npm run build
cd ..
```

エラーがないことを確認してください。

#### Web のビルド

```bash
cd web
npm run build
cd ..
```

`web/dist/` ディレクトリにビルド成果物が生成されることを確認してください。

### 4. 本番デプロイ

#### 4-1. Functions（バックエンド）のデプロイ

```bash
cd functions
npm run deploy
```

または

```bash
firebase deploy --only functions
```

**デプロイ対象**:
- `functions/src/lib/` 配下の全モジュール（新規実装分を含む）
- `functions/src/api/` 配下の全APIエンドポイント
- `functions/src/index.ts`

**デプロイ完了の確認**:
- コンソールに `✔ Deploy complete!` と表示される
- Functions URL が表示される: `https://asia-northeast1-compass-31e9e.cloudfunctions.net/api`

#### 4-2. Hosting（フロントエンド）のデプロイ

```bash
cd web
npm run build
cd ..
firebase deploy --only hosting
```

**デプロイ対象**:
- `web/dist/` 配下の全ファイル

**デプロイ完了の確認**:
- コンソールに `✔ Deploy complete!` と表示される
- Hosting URL が表示される: `https://compass-31e9e.web.app`

### 5. 動作確認

#### 5-1. Web アプリへのアクセス

ブラウザで https://compass-31e9e.web.app/ にアクセスし、以下を確認:

- ログイン画面が表示される
- 許可されたメールアドレスでログインできる
- ダッシュボードが正常に表示される

#### 5-2. API の動作確認

```bash
# プロジェクト一覧の取得（要認証）
curl https://asia-northeast1-compass-31e9e.cloudfunctions.net/api/projects \
  -H "Authorization: Bearer YOUR_ID_TOKEN"
```

#### 5-3. 主要機能の確認

- [ ] プロジェクトの作成・編集・削除
- [ ] タスクの作成・編集・完了
- [ ] 担当者の追加
- [ ] Excel インポート・エクスポート
- [ ] ガントチャートの表示
- [ ] カンバンボードの表示

---

## トラブルシューティング

### デプロイエラー

#### 認証エラー

```
Error: HTTP Error: 401, Request had invalid authentication credentials.
```

**対処法**:
```bash
firebase login --reauth
```

#### ビルドエラー

```
Error: There was an error deploying functions
```

**対処法**:
1. `functions/` ディレクトリで `npm run build` を実行してエラーを確認
2. TypeScript のエラーを修正
3. 再度デプロイ

#### 権限エラー

```
Error: Permission denied
```

**対処法**:
1. Google Cloud Console (https://console.cloud.google.com/iam-admin/iam?project=compass-31e9e) にアクセス
2. 自分のアカウントに以下のロールがあることを確認:
   - Firebase Admin
   - Cloud Functions Developer
   - Cloud Datastore User

### API エラー

#### 401 Unauthorized

**原因**: メールアドレスが許可リストに含まれていない

**対処法**:
1. `functions/.env` の `ALLOW_EMAILS` を確認
2. Firebase Functions の環境変数を確認:
   ```bash
   firebase functions:config:get
   ```
3. 必要に応じて環境変数を更新:
   ```bash
   firebase functions:config:set allow.emails="*@archi-prisma.co.jp,s.sakuramoto@archi-prisma.co.jp"
   ```

#### 500 Internal Server Error

**原因**: Functions 内でエラーが発生している

**対処法**:
1. Functions のログを確認:
   ```bash
   firebase functions:log
   ```
   または Google Cloud Console のログビューアー
2. エラー内容を確認して修正

### Firestore エラー

#### PERMISSION_DENIED

**原因**: Firestore セキュリティルールが正しく設定されていない

**対処法**:
1. `firestore.rules` を確認
2. ルールをデプロイ:
   ```bash
   firebase deploy --only firestore:rules
   ```

---

## ロールバック手順

### Functions のロールバック

```bash
# デプロイ履歴を確認
gcloud functions list --project=compass-31e9e

# 特定のバージョンにロールバック（Google Cloud Console から実行）
```

### Hosting のロールバック

```bash
# デプロイ履歴を確認
firebase hosting:channel:list

# 前のバージョンにロールバック
firebase hosting:clone SOURCE_SITE_ID:SOURCE_CHANNEL_ID TARGET_SITE_ID:live
```

---

## 定期メンテナンス

### ログの確認

```bash
# Functions のログ
firebase functions:log --only api

# または Google Cloud Console
https://console.cloud.google.com/logs/query?project=compass-31e9e
```

### データベースのバックアップ

Firestore は自動バックアップが有効ですが、手動エクスポートも可能:

```bash
gcloud firestore export gs://compass-31e9e-backup/$(date +%Y%m%d) \
  --project=compass-31e9e
```

### 依存関係の更新

```bash
# Functions
cd functions
npm update
npm audit fix

# Web
cd ../web
npm update
npm audit fix
```

---

## 参考リンク

- **Firebase Console**: https://console.firebase.google.com/project/compass-31e9e
- **Google Cloud Console**: https://console.cloud.google.com/home/dashboard?project=compass-31e9e
- **Firestore Database**: https://console.firebase.google.com/project/compass-31e9e/firestore
- **Functions ログ**: https://console.cloud.google.com/functions/list?project=compass-31e9e
- **Hosting**: https://console.firebase.google.com/project/compass-31e9e/hosting

---

## 緊急連絡先

問題が発生した場合は、以下に連絡してください:

- **開発担当**: s.sakuramoto@archi-prisma.co.jp
- **Firebase サポート**: https://firebase.google.com/support

---

**最終更新日**: 2025年10月17日

