# 工程管理ダッシュボード 全面リニューアル指示書

## 目的
現在の工程表ビューを、実務で使いやすい本格的なガントチャートに全面刷新する。

---

## 1. 基本方針

### ユーザー体験の優先順位
1. **工程表が主役**: 画面の80-90%を工程表が占める
2. **直感的な操作**: クリック、ドラッグ、キーボードショートカットで全操作可能
3. **視認性**: タスク名、担当者、進捗が一目でわかる
4. **実務対応**: Excel並みの編集しやすさ

---

## 2. レイアウト設計

### 全体構成
```
┌─────────────────────────────────────────────────────┐
│ ヘッダー (固定、50px)                                  │
│ [プロジェクト名] [ビュー切替] [エクスポート] [設定]      │
├──────┬──────────────────────────────────────────────┤
│      │ ツールバー (40px)                              │
│ サイド│ [+ タスク追加] [フィルター▼] [今日] [ズーム]    │
│ バー  ├──────────────────────────────────────────────┤
│      │                                                │
│ (折畳)│          ガントチャート (残り全画面)            │
│ 可能  │                                                │
│ 200px │  ┌─────────────┬─────────────────────────┐ │
│      │  │ タスク一覧   │  タイムライン             │ │
│      │  │ (左固定)     │  (横スクロール)           │ │
│      │  ├─────────────┼─────────────────────────┤ │
│      │  │ □ タスク1   │  ■■■■■■              │ │
│      │  │   担当: 櫻本 │     9/1 ─→ 9/10          │ │
│      │  │ □ タスク2   │        ■■■■            │ │
│      │  │   担当: 中村 │           9/5 ─→ 9/12    │ │
│      │  └─────────────┴─────────────────────────┘ │
└──────┴──────────────────────────────────────────────┘
```

### サイドバー (折りたたみ可能)
- プロジェクト一覧
- 担当者フィルター
- ステータスフィルター
- 折りたたみボタン (←/→)

---

## 3. ガントチャート詳細設計

### 3.1 タスク一覧部分 (左側固定、幅300-400px)

**カラム構成:**
```
┌──┬────────────────┬──────┬────────┬─────┐
│☑ │ タスク名        │ 担当 │ 期間   │ 進捗│
├──┼────────────────┼──────┼────────┼─────┤
│☑ │ 基本設計        │ 櫻本 │ 5日    │ 80% │
│☐ │ レイアウト調整  │ 中村 │ 3日    │ 30% │
└──┴────────────────┴──────┴────────┴─────┘
```

**機能:**
- チェックボックス: タスク完了マーク
- タスク名: クリックで編集モード
- 担当者: アバター表示、クリックで変更
- 期間: 自動計算
- 進捗: プログレスバー

### 3.2 タイムライン部分 (右側、横スクロール)

**表示要素:**
- X軸: 日付ラベル (月/日 + 曜日)
- 今日の線: 赤い縦線で強調
- 週末: 薄いグレー背景
- タスクバー: 
  - 高さ: 32px
  - 角丸: 6px
  - 内部にタスク名を表示 (省略記号付き)
  - ステータスで色分け

**インタラクション:**
- ドラッグ: タスク期間の移動
- 左右端ドラッグ: 期間の延長/短縮
- ダブルクリック: 詳細編集モーダル
- 右クリック: コンテキストメニュー

---

## 4. 技術実装指示

### 4.1 使用技術
- **既存のまま**: React, TypeScript, Tailwind CSS
- **削除**: Recharts (Y軸ラベル問題のため)
- **追加検討**: 
  - `date-fns` (日付操作)
  - SVGまたはCanvasで直接描画

### 4.2 コンポーネント構成

```
src/
├── components/
│   ├── GanttChart/
│   │   ├── GanttChart.tsx          # メインコンポーネント
│   │   ├── GanttHeader.tsx         # ヘッダー
│   │   ├── GanttToolbar.tsx        # ツールバー
│   │   ├── GanttTaskList.tsx       # タスク一覧 (左側)
│   │   ├── GanttTimeline.tsx       # タイムライン (右側)
│   │   ├── GanttTaskBar.tsx        # タスクバー
│   │   ├── GanttTimeAxis.tsx       # 時間軸
│   │   ├── TaskEditModal.tsx       # タスク編集モーダル
│   │   └── ContextMenu.tsx         # 右クリックメニュー
│   └── Sidebar/
│       └── CollapsibleSidebar.tsx  # 折りたたみサイドバー
```

### 4.3 データ構造

```typescript
interface GanttTask {
  id: string;
  name: string;
  startDate: Date;
  endDate: Date;
  assignee: string;
  assigneeAvatar?: string;
  progress: number; // 0-100
  status: 'not_started' | 'in_progress' | 'on_hold' | 'completed' | 'overdue';
  projectId: string;
  projectName: string;
  dependencies?: string[]; // タスクIDの配列
  milestone?: boolean;
  description?: string;
  estimatedHours?: number;
}

interface GanttViewState {
  tasks: GanttTask[];
  viewMode: 'day' | 'week' | 'month'; // ズームレベル
  dateRange: { start: Date; end: Date };
  selectedTaskIds: string[];
  filters: {
    projectIds: string[];
    assignees: string[];
    statuses: string[];
  };
  sidebarCollapsed: boolean;
}
```

---

## 5. 具体的な実装手順

### Phase 1: レイアウト刷新
1. `GanttChart.tsx` を完全に書き直し
2. 左右分割レイアウトの実装
3. 固定ヘッダー・ツールバーの実装
4. 折りたたみサイドバーの実装

### Phase 2: タスク一覧部分
1. `GanttTaskList.tsx` の実装
2. チェックボックス、タスク名、担当者、進捗の表示
3. インライン編集機能
4. 仮想スクロール対応 (大量タスク対応)

### Phase 3: タイムライン部分
1. `GanttTimeline.tsx` の実装
2. 日付軸の正確な描画
3. タスクバーの配置 (Y座標を正確に計算)
4. 今日の線、週末背景の表示

### Phase 4: インタラクション
1. タスクバーのドラッグ&ドロップ
2. 期間の延長/短縮
3. ダブルクリックで編集モーダル
4. 右クリックメニュー

### Phase 5: 高度な機能
1. タスク依存関係の矢印表示
2. マイルストーン表示
3. クリティカルパスの強調
4. Excel/PDFエクスポート

---

## 6. 重要な実装ポイント

### 6.1 Y軸ラベルの問題解決
**現在の問題**: Rechartsを使用しているが、Y軸ラベルが表示されない

**解決策**: 
- **Rechartsを使わない**: 純粋なHTML/CSS/SVGで実装
- タスク一覧とタイムラインを完全に分離
- タスク一覧は通常のHTML要素
- タイムラインはSVGまたはCanvas
- 両方を同期スクロール

### 6.2 スクロール同期
```typescript
const handleScroll = (e: React.UIEvent<HTMLDivElement>) => {
  const scrollTop = e.currentTarget.scrollTop;
  // タスク一覧とタイムラインの縦スクロールを同期
  taskListRef.current.scrollTop = scrollTop;
  timelineRef.current.scrollTop = scrollTop;
};
```

### 6.3 日付軸の計算
```typescript
const calculateDateTicks = (startDate: Date, endDate: Date, viewMode: 'day' | 'week' | 'month') => {
  const ticks: Date[] = [];
  const current = new Date(startDate);
  
  while (current <= endDate) {
    ticks.push(new Date(current));
    if (viewMode === 'day') {
      current.setDate(current.getDate() + 1);
    } else if (viewMode === 'week') {
      current.setDate(current.getDate() + 7);
    } else {
      current.setMonth(current.getMonth() + 1);
    }
  }
  
  return ticks;
};
```

### 6.4 タスクバーの位置計算
```typescript
const calculateTaskBarPosition = (task: GanttTask, dateRange: { start: Date; end: Date }) => {
  const totalDays = differenceInDays(dateRange.end, dateRange.start);
  const startOffset = differenceInDays(task.startDate, dateRange.start);
  const duration = differenceInDays(task.endDate, task.startDate);
  
  return {
    left: `${(startOffset / totalDays) * 100}%`,
    width: `${(duration / totalDays) * 100}%`,
  };
};
```

---

## 7. スタイリング指針

### カラーパレット
```css
/* ステータス別の色 */
--status-not-started: #94a3b8;  /* グレー */
--status-in-progress: #2563eb;  /* 青 */
--status-on-hold: #f97316;      /* オレンジ */
--status-completed: #0f766e;    /* 緑 */
--status-overdue: #dc2626;      /* 赤 */

/* UI要素 */
--bg-primary: #ffffff;
--bg-secondary: #f8fafc;
--border-color: #e2e8f0;
--text-primary: #0f172a;
--text-secondary: #64748b;
--today-line: #dc2626;
--weekend-bg: #f8fafc;
```

### タスクバーのスタイル
```css
.task-bar {
  height: 32px;
  border-radius: 6px;
  padding: 0 12px;
  display: flex;
  align-items: center;
  font-size: 13px;
  font-weight: 500;
  cursor: move;
  transition: all 0.2s;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.task-bar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
}

.task-bar.dragging {
  opacity: 0.7;
  cursor: grabbing;
}
```

---

## 8. パフォーマンス最適化

### 仮想スクロール
- タスクが100件以上の場合、仮想スクロールを実装
- `react-window` または `react-virtualized` を使用

### メモ化
```typescript
const MemoizedTaskBar = React.memo(TaskBar, (prev, next) => {
  return (
    prev.task.id === next.task.id &&
    prev.task.startDate === next.task.startDate &&
    prev.task.endDate === next.task.endDate &&
    prev.task.progress === next.task.progress
  );
});
```

---

## 9. テスト観点

### 動作確認項目
- [ ] タスクバーのドラッグで期間が変更される
- [ ] 左右端のドラッグで期間が延長/短縮される
- [ ] ダブルクリックで編集モーダルが開く
- [ ] タスク名がバーの中央に正確に表示される
- [ ] Y軸のタスク一覧とタイムラインのバーが正確に揃っている
- [ ] 縦スクロールが同期する
- [ ] 横スクロールでタイムラインが移動する
- [ ] 今日の線が正確な位置に表示される
- [ ] 週末の背景色が表示される
- [ ] 100件以上のタスクでもスムーズに動作する

---

## 10. 参考実装例

### タスクバーのドラッグ実装
```typescript
const TaskBar: React.FC<{ task: GanttTask; onUpdate: (task: GanttTask) => void }> = ({ task, onUpdate }) => {
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState<{ x: number; startDate: Date } | null>(null);

  const handleMouseDown = (e: React.MouseEvent) => {
    setIsDragging(true);
    setDragStart({ x: e.clientX, startDate: task.startDate });
  };

  const handleMouseMove = (e: MouseEvent) => {
    if (!isDragging || !dragStart) return;
    
    const deltaX = e.clientX - dragStart.x;
    const daysMoved = Math.round(deltaX / PIXELS_PER_DAY);
    
    const newStartDate = addDays(dragStart.startDate, daysMoved);
    const duration = differenceInDays(task.endDate, task.startDate);
    const newEndDate = addDays(newStartDate, duration);
    
    onUpdate({ ...task, startDate: newStartDate, endDate: newEndDate });
  };

  const handleMouseUp = () => {
    setIsDragging(false);
    setDragStart(null);
  };

  useEffect(() => {
    if (isDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
      return () => {
        window.removeEventListener('mousemove', handleMouseMove);
        window.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isDragging]);

  return (
    <div
      className={`task-bar ${isDragging ? 'dragging' : ''}`}
      onMouseDown={handleMouseDown}
      style={{ backgroundColor: STATUS_COLORS[task.status] }}
    >
      {task.name}
    </div>
  );
};
```

---

## 11. 優先順位

### 最優先 (Phase 1-3)
1. レイアウト刷新
2. タスク一覧とタイムラインの正確な同期
3. Y軸ラベル問題の完全解決

### 次優先 (Phase 4)
4. ドラッグ&ドロップ
5. 編集モーダル

### 後回し可能 (Phase 5)
6. 依存関係表示
7. エクスポート機能

---

## 12. Claude Codeへの指示

**最初に実装すべきこと:**
1. `src/components/GanttChart/GanttChart.tsx` を新規作成
2. 左右分割レイアウトを実装 (Rechartsは使わない)
3. タスク一覧部分を実装 (HTML table)
4. タイムライン部分を実装 (SVG)
5. 両方のスクロールを同期

**コード生成時の注意:**
- TypeScriptの型を厳密に定義
- Tailwind CSSでスタイリング
- コメントは日本語で記述
- 既存のApp.tsxとの統合を考慮

**成果物:**
- 完全に動作する新しいGanttChartコンポーネント
- サンプルデータでの動作確認
- 既存のFirestoreデータとの統合方法

---

## 13. 既存コードとの統合

### App.tsxの修正箇所
```typescript
// 既存のGanttChartViewをインポート
import { GanttChartView } from './components/GanttChart';

// 新しいGanttChartに置き換え
import { GanttChart } from './components/GanttChart/GanttChart';

// データ変換
const ganttTasks: GanttTask[] = filteredTasks.map(task => ({
  id: task.id,
  name: task.name || task.タスク名 || '（無題）',
  startDate: new Date(task.開始日 || task.start),
  endDate: new Date(task.終了日 || task.end),
  assignee: task.assignee || task.担当者 || '未設定',
  progress: task.進捗率 || 0,
  status: task.status || task.ステータス || 'not_started',
  projectId: task.projectId,
  projectName: task.projectName,
}));

// 新しいコンポーネントを使用
<GanttChart tasks={ganttTasks} />
```

---

## 14. 追加要件

### アクセシビリティ
- キーボードナビゲーション対応
- スクリーンリーダー対応
- ARIA属性の適切な設定

### レスポンシブ対応
- タブレット: サイドバー自動折りたたみ
- スマホ: タスク一覧とタイムラインを上下配置

### エラーハンドリング
- 日付の不正値チェック
- タスクの重複チェック
- 依存関係の循環参照チェック

---

以上の指示書をClaude Codeに渡して、実装を依頼してください。

